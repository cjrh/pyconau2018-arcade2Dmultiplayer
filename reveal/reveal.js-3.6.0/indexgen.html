<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>reveal.js</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/github.css">

    <style>
        .reveal {
            font-size: 36px;
        }
        .reveal pre {
            width: unset;
        }

        .reveal a {
            color: #2244ff;
        }

        .reveal mark {
            color: #080e1b;
            background-color: #fff400;
        }

        .container {
            display: flex;
        }

        .col {
            flex: 1;
        }

        .reveal div.container p {
            margin: 0;
        }

        .reveal section img {
            border: none;
        }

        .reveal {
            font-family: "Liberation Sans", SansSerif;
        }

        .reveal code {
            font-family: "Liga Cousine", "Liberation Mono", Monospaced;
        }

        .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
            font-family: "Liberation Sans", SansSerif;
        }

        .reveal h1 {
            font-size: 2.6em;
        }

        .reveal h2 {
            font-size: 1.8em;
        }

        .hljs {
            color: black;
        }

        button.runprogram {
            font-family: "Liberation Sans", SansSerif;
            color: #000000 !important;
            text-transform: uppercase;
            background: #9c9c9c;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            border: none;
        }

        button.runprogram:hover {
            background: #00c2ea;
            letter-spacing: 1px;
            -webkit-box-shadow: 0px 5px 40px -10px rgba(0,0,0,0.57);
            -moz-box-shadow: 0px 5px 40px -10px rgba(0,0,0,0.57);
            box-shadow: 5px 40px -10px rgba(0,0,0,0.57);
            transition: all 0.4s ease 0s;
        }
    </style>

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
  <h1>multiplayer 2D gaming</h1>
  <h2>with python-arcade</h2>
  <p style="font-size: 0.7em">@caleb_hattingh ‚óè 
    <a href="github.com/cjrh/pyconau2018-arcade2Dmultiplayer">github.com/cjrh/pyconau2018-arcade2Dmultiplayer</a>
  </p>
</section>
<section>
  <h2>Goals</h2>
  <p>Build a simple multiplayer game!</p>
</section>
<section>
  <h2>Goals</h2>
  <p>
    <s>Build a simple multiplayer game!</s>
  </p>
  <div style="margin-top: 30px;"></div>
  <p>Show &amp; tell the building blocks</p>
</section>
<section>
  <h2>about me</h2>
  <ul>
    <li>
      <p>Network automation at 
        <img height="42" src="/img/pccwglobal.png" style="vertical-align:middle;">
      </p>
    </li>
    <li>Books and videos at O'Reilly Safari:</li>
  </ul>
  <div>
    <img height="250" src="/img/cythoncover.jpg">
    <img height="250" src="/img/20libscover.png">
    <div style="display: inline-block">
      <p style="font-size: 0.6em; margin: 0">April 2018!</p>
      <img height="250" src="/img/aiocover.png">
    </div>
  </div>
  <a href="https://www.safaribooksonline.com/search/?query=caleb%20hattingh" style="font-size: 0.6em;">https://www.safaribooksonline.com/search/?query=caleb%20hattingh</a>
</section>
<section>
  <h2>Python-Arcade</h2>
  <p>created by Paul Craven ‚óè
    <a href="http://arcade.academy">http://arcade.academy</a>
  </p>
  <div style="display: flex; margin: auto">
    <img data-src="img/penguin.png" height="48" width="48">
    <pre><code class="hljs bash" contenteditable="contenteditable" data-trim="data-trim">                    (venv) $ pip install arcade
                </code></pre>
  </div>
  <div style="display: flex; margin: auto">
    <img data-src="img/windows_icon.png" height="48" width="48">
    <pre><code class="hljs cmd" contenteditable="contenteditable" data-trim="data-trim">                    (venv) C:\mygame&gt; pip install arcade
                </code></pre>
  </div>
</section>
<section>
  <img src="/img/arcade_doc_screenshot.png">
</section>
<section>
  <h2>Why Python-Arcade?</h2>
  <ul>
    <li>Easy to install</li>
    <li>OpenGL (via Pyglet)</li>
    <li>Modern (Python 3 only, type annotations)</li>
    <li>
      <code>(0, 0)</code> is at the bottom-left
    </li>
    <li>Very clean, simple API</li>
    <li class="fragment">
      <strong>Examples üéÅüéÅüéÅ</strong>
    </li>
  </ul>
</section>
<section>
  <h2>
    <u>lots</u> of examples
  </h2>
  <div class="container" style="font-size: 0.3em;">
    <div class="col">
      <p>array_backed_grid.py</p>
      <p>array_backed_grid_buffered.py</p>
      <p>asteroid_smasher.py</p>
      <p>bouncing_ball.py</p>
      <p>bouncing_balls.py</p>
      <p>bouncing_rectangle.py</p>
      <p>decorator_drawing_example.py</p>
      <p>decorator_drawing_with_loops.py</p>
      <p>decorator_test.py</p>
      <p>drawing_primitives.py</p>
      <p>drawing_text.py</p>
      <p>drawing_with_functions.py</p>
      <p>drawing_with_loops.py</p>
      <p>full_screen_example.py</p>
      <p>gradients.py</p>
      <p>gui_text_button.py</p>
      <p>happy_face.py</p>
      <p>instruction_and_game_over_screens.py</p>
      <p>isometric_example.py</p>
      <p>joystick.py</p>
      <p>lines_buffered.py</p>
      <p>maze_depth_first.py</p>
      <p>maze_recursive.py</p>
      <p>mountains_midpoint_displacement.py</p>
      <p>mountains_random_walk.py</p>
      <p>move_joystick.py</p>
      <p>move_keyboard.py</p>
      <p>move_mouse.py</p>
      <p>nested_loops_bottom_left_triangle.py</p>
      <p>nested_loops_bottom_right_triangle.py</p>
      <p>nested_loops_box.py</p>
    </div>
    <div class="col">
      <p>nested_loops_top_left_triangle.py</p>
      <p>nested_loops_top_right_triangle.py</p>
      <p>pinball.py</p>
      <p>procedural_caves_bsp.py</p>
      <p>procedural_caves_cellular.py</p>
      <p>pymunk_2.py</p>
      <p>pymunk_box_stacks.py</p>
      <p>pymunk_pegboard.py</p>
      <p>radar_sweep.py</p>
      <p>resizable_window.py</p>
      <p>scratch.py</p>
      <p>shape_list_demo_1.py</p>
      <p>shape_list_demo_2.py</p>
      <p>shape_list_demo_3.py</p>
      <p>shape_list_demo_person.py</p>
      <p>shape_list_demo_skylines.py</p>
      <p>shape_list_non_center_rotate.py</p>
      <p>shapes.py</p>
      <p>snow.py</p>
      <p>sound.py</p>
      <p>sound_test.py</p>
      <p>sprite_bullets.py</p>
      <p>sprite_bullets_aimed.py</p>
      <p>sprite_bullets_enemy_aims.py</p>
      <p>sprite_bullets_periodic.py</p>
      <p>sprite_bullets_random.py</p>
      <p>sprite_change_coins.py</p>
      <p>sprite_collect_coins.py</p>
      <p>sprite_collect_coins_background.py</p>
      <p>sprite_collect_coins_diff_levels.py</p>
      <p>sprite_collect_coins_move_bouncing.py</p>
    </div>
    <div class="col">
      <p>sprite_collect_coins_move_circle.py</p>
      <p>sprite_collect_coins_move_down.py</p>
      <p>sprite_collect_coins_move_down_improved.py</p>
      <p>sprite_collect_rotating.py</p>
      <p>sprite_enemies_in_platformer.py</p>
      <p>sprite_explosion.py</p>
      <p>sprite_face_left_or_right.py</p>
      <p>sprite_follow_simple.py</p>
      <p>sprite_follow_simple_2.py</p>
      <p>sprite_move_animation.py</p>
      <p>sprite_move_joystick.py</p>
      <p>sprite_move_keyboard.py</p>
      <p>sprite_move_scrolling.py</p>
      <p>sprite_move_walls.py</p>
      <p>sprite_moving_platforms.py</p>
      <p>sprite_no_coins_on_walls.py</p>
      <p>sprite_ramps.py</p>
      <p>sprite_rooms.py</p>
      <p>sprite_simple_platformer.py</p>
      <p>sprite_tiled_map.py</p>
      <p>starting_template.py</p>
      <p>starting_template_simple.py</p>
      <p>stress_test_collision.py</p>
      <p>stress_test_draw_moving.py</p>
      <p>stress_test_draw_simple.py</p>
      <p>test.py</p>
      <p>test2.py</p>
      <p>test3.py</p>
      <p>timer.py</p>
    </div>
  </div>
</section>
<section>
  <h2>lots of examples</h2>
  <ul>
    <li>
      <pre><code class="hljs bash" contenteditable="true" data-noescape="true" data-trim="true">(venv) $ python -m arcade.examples.<mark>bouncing_ball</mark></code></pre>
      <button class="runprogram" cmd="arcade.examples.bouncing_ball">bouncing_ball</button>
    </li>
    <li>
      <pre><code class="hljs bash" contenteditable="true" data-noescape="true" data-trim="true">(venv) $ python -m arcade.examples.<mark>sprite_collect_coins</mark></code></pre>
      <button class="runprogram" cmd="arcade.examples.sprite_collect_coins">sprite_collect_coins</button>
    </li>
    <li>
      <pre><code class="hljs bash" contenteditable="true" data-noescape="true" data-trim="true">(venv) $ python -m arcade.examples.<mark>sprite_move_keyboard</mark></code></pre>
      <button class="runprogram" cmd="arcade.examples.sprite_move_keyboard">sprite_move_keyboard</button>
    </li>
  </ul>
</section>
<section>
  <h2>Intro: Python-Arcade</h2>
</section>
<section style="top: 50px">
  <h2>Getting started</h2>
  <pre style="font-size: 0.4em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">import arcade
from pymunk.vec2d import Vec2d
from demos.movement import KeysPressed, apply_movement

class MyGame(arcade.Window):
    def __init__(self, width, height):
        super().__init__(width, height, title=&quot;Getting Started&quot;)
        self.player_position = Vec2d(400, 300)
        self.keys_pressed = KeysPressed()

    <mark>def update</mark>(self, dt):
        self.player_position = apply_movement(
            speed=600, dt=dt, current_position=self.player_position, kp=self.keys_pressed)

    <mark>def on_draw</mark>(self):
        arcade.start_render()
        arcade.draw_rectangle_filled(
            center_x=self.player_position.x, center_y=self.player_position.y,
            width=50, height=50, color=arcade.color.YELLOW)

    <mark>def on_key_press</mark>(self, key, modifiers):
        self.keys_pressed.keys[key] = True

    <mark>def on_key_release</mark>(self, key, modifiers):
        self.keys_pressed.keys[key] = False

if __name__ == &quot;__main__&quot;:
    window = MyGame(800, 600)
    arcade.run()
</code></pre>
  <button class="runprogram" cmd="demos.getting_started">getting_started.py</button>
</section>
<section style="top: 50px">
  <h2>Getting started</h2>
  <pre style="font-size: 0.4em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">import arcade
from pymunk.vec2d import Vec2d
from demos.movement import KeysPressed, apply_movement

class MyGame(arcade.Window):
    def __init__(self, width, height):
        super().__init__(width, height, title=&quot;Getting Started&quot;)
        self.player_position = Vec2d(400, 300)
        <mark>self.keys_pressed</mark> = KeysPressed()

    def update(self, dt):
        self.player_position = <mark>apply_movement</mark>(
            speed=600, dt=dt, current_position=self.player_position, kp=self.keys_pressed)

    def on_draw(self):
        arcade.start_render()
        arcade.draw_rectangle_filled(
            center_x=self.player_position.x, center_y=self.player_position.y,
            width=50, height=50, color=arcade.color.YELLOW)

    def on_key_press(self, key, modifiers):
        <mark>self.keys_pressed.keys[key] = True</mark>

    def on_key_release(self, key, modifiers):
        <mark>self.keys_pressed.keys[key] = False</mark>

if __name__ == &quot;__main__&quot;:
    window = MyGame(800, 600)
    arcade.run()
</code></pre>
  <button class="runprogram" cmd="demos.getting_started">getting_started.py</button>
</section>
<section>
  <h2>&quot;Movement&quot; utils</h2>
  <pre style="font-size: 0.5em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">import arcade
from pymunk import Vec2d

MOVE_MAP = {
    arcade.key.UP: Vec2d(0, 1),
    arcade.key.DOWN: Vec2d(0, -1),
    arcade.key.LEFT: Vec2d(-1, 0),
    arcade.key.RIGHT: Vec2d(1, 0),
}

class KeysPressed:
    def __init__(self):
        self.keys = {k: False for k in MOVE_MAP}

def apply_movement(speed, dt, current_position: Vec2d, kp: KeysPressed) -&gt; Vec2d:
    delta_position = sum(kp.keys[k] * MOVE_MAP[k] for k in kp.keys)
    return <mark>current_position + delta_position * speed * dt</mark>

def apply_movement_norm(speed, dt, current_position: Vec2d, kp: KeysPressed) -&gt; Vec2d:
    delta_position = sum(kp.keys[k] * MOVE_MAP[k] for k in kp.keys)
    return current_position + delta_position.normalized() * speed * dt
</code></pre>
</section>
<section>
  <h2>üéÅtip #1: use a vector class</h2>
  <p>Use the one in 
    <strong>pymunk</strong>
  </p>
  <pre><code class="hljs python" contenteditable="true" data-trim="true">&gt;&gt;&gt; from pymunk.vec2d import Vec2d
&gt;&gt;&gt; pixel = Vec2d(3, 4)
&gt;&gt;&gt; pixel.x
3
&gt;&gt;&gt; pixel.y
4
&gt;&gt;&gt;
&gt;&gt;&gt; pixel + 2 * pixel
Vec2d(9, 12)
&gt;&gt;&gt; pixel.length
5.0
&gt;&gt;&gt; pixel.length = 1
&gt;&gt;&gt; pixel
Vec2d(0.6, 0.8)
</code></pre>
</section>
<section>
  <h2>&quot;Movement&quot; utils</h2>
  <pre style="font-size: 0.5em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">import arcade
from pymunk import Vec2d

MOVE_MAP = {
    arcade.key.UP: Vec2d(0, 1),
    arcade.key.DOWN: Vec2d(0, -1),
    arcade.key.LEFT: Vec2d(-1, 0),
    arcade.key.RIGHT: Vec2d(1, 0),
}

class KeysPressed:
    def __init__(self):
        self.keys = {k: False for k in MOVE_MAP}

def apply_movement(speed, dt, current_position: Vec2d, kp: KeysPressed) -&gt; Vec2d:
    delta_position = sum(kp.keys[k] * MOVE_MAP[k] for k in kp.keys)
    return current_position + delta_position * speed * dt

def apply_movement_norm(speed, dt, current_position: Vec2d, kp: KeysPressed) -&gt; Vec2d:
    delta_position = sum(kp.keys[k] * MOVE_MAP[k] for k in kp.keys)
    return current_position + delta_position<mark>.normalized()</mark> * speed * dt
</code></pre>
  <button class="runprogram" cmd="demos.getting_started_norm">Normalize your movement vector!</button>
</section>
<section>
  <section data-background-image="/img/shallplaygame.jpg"></section>
</section>
<section>
  <section data-background-image="/img/fortnite3.jpg"></section>
</section>
<section>
  <section data-background-image="/img/starcraft2.jpg"></section>
</section>
<section>
  <section data-background-image="/img/awesomenautsplay.jpg"></section>
</section>
<section>
  <h2>Network models</h2>
  <section>
    <ol>
      <li class="fragment">
        <strong>Client-server: </strong>clients only &quot;capture inputs&quot;
        <ul style="font-size: 0.7em;">
          <li>Fortnite</li>
          <li>Quake</li>
          <li>Unreal Tournament</li>
          <li>Overwatch</li>
        </ul>
      </li>
      <li class="fragment">
        <strong>Peer-to-peer (lockstep): </strong>synced sim on each client
        <ul style="font-size: 0.7em;">
          <li>Command &amp; Conquer</li>
          <li>Age of Empires</li>
          <li>StarCraft</li>
          <li>Supreme Commander 2</li>
        </ul>
      </li>
      <li class="fragment">
        <strong>Peer-to-peer: </strong>each client calculates self
        <ul style="font-size: 0.7em;">
          <li>Awesomenauts</li>
        </ul>
      </li>
    </ol>
  </section>
  <section>
    <p style="font-size: 0.6em">References</p>
    <p style="font-size: 0.6em">
      <a href="https://gafferongames.com/post/what_every_programmer_needs_to_know_about_game_networking/">What every programmer needs to know about game networking - Glenn Fiedler</a>
    </p>
    <p style="font-size: 0.6em">
      <a href="http://joostdevblog.blogspot.com/2014/09/core-network-structures-for-games.html">Core network structures for games - Joost van Dongen</a>
    </p>
    <p style="font-size: 0.6em">
      <a href="https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking">Source Multiplayer Networking - Valve</a>
    </p>
  </section>
</section>
<section>
  <h2>Client-server: The Big Picture</h2>
  <img src="/img/server-based-network.svg" width="500">
</section>
<section>
  <h2>Communication</h2>
  <ol>
    <li>Player inputs: client ü†ä server</li>
    <li>Game state: client ü†à server</li>
    <li>TCP versus UDP</li>
  </ol>
</section>
<section>
  <h2>1. Player input state</h2>
  <p>send client ü†ä server</p>
  <ul>
    <li>
      <b>inputs </b>not &quot;speed&quot; or &quot;position&quot;
    </li>
    <li>Use dataclasses:</li>
  </ul>
  <pre style="font-size: 0.4em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">from typing import Dict
from dataclasses import dataclass, asdict, field
from demos.movement import MOVE_MAP

@dataclass
<mark>class PlayerEvent</mark>:
    &quot;&quot;&quot;
    p = PlayerEvent()
    p.keys[arcade.key.UP] = True
    &quot;&quot;&quot;
    keys: Dict[int, bool] = field(
        default_factory=lambda: {k: False for k in MOVE_MAP}
    )

    def __post_init__(self):
        # Cast keys to int (JSON deserialization situations)
        self.keys = {int(k): v for k, v in self.keys.items()}

    def asdict(self):
        return asdict(self)
</code></pre>
</section>
<section>
  <h2>2. Game state</h2>
  <p>send server ü†ä client</p>
  <pre style="font-size: 0.4em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">from typing import List
import json
from dataclasses import dataclass, asdict


@dataclass
class PlayerState:
    updated: float = 0
    <mark>x: float = 0</mark>
    <mark>y: float = 0</mark>
    health: float = 0
    ammo: float = 0


@dataclass
<mark>class GameState</mark>:
    player_states: List[PlayerState]

    def to_json(self):
        d = dict(
            player_states=[asdict(p) for p in self.player_states],
        )
        return json.dumps(d)

    def from_json(self, data):
        d = json.loads(data)
        for i, p in enumerate(d['player_states']):
            self.player_states[i] = PlayerState(**p)
</code></pre>
</section>
<section>
  <h2>3. TCP vs UDP</h2>
  <ul>
    <li class="fragment">Problem: TCP is 
      <strong>too </strong>reliable
      <ul>
        <li>Dropped packets causes latency (bad!)</li>
        <li>Sometimes packet loss is ok</li>
      </ul>
    </li>
    <li class="fragment">UDP chosen for 
      <u>control</u> (not merely speed)
      <ul>
        <li>Can choose when to allow packet loss...</li>
        <li>BUT: it's much more work</li>
      </ul>
    </li>
  </ul>
</section>
<section>
  <p>No time for UDP!</p>
  <img src="/img/greenninja.jpg">
  <p>Instead, we'll just show TCP (and ZeroMQ) for simplicity.</p>
</section>
<section>
  <h2>Brief intro to ZeroMQ</h2>
  <p>Thin abstraction over TCP ‚óè &quot;magic&quot; sockets</p>
  <ul>
    <li class="fragment">Handling player inputs
      <ul>
        <li>
          <b>PUSH + PULL </b>sockets
        </li>
        <li>all clients push to a single server</li>
      </ul>
    </li>
    <li class="fragment">Handling game state
      <ul>
        <li>
          <b>PUB + SUB </b>sockets
        </li>
        <li>Server pushes to all clients</li>
      </ul>
    </li>
  </ul>
</section>
<section>
  <h2>ZMQ client &amp; server</h2>
  <div class="container">
    <div class="col" style="padding: 10px">
      <h3>Client (player)</h3>
      <pre><code class="hljs python" contenteditable="true" data-trim="true">from asyncio import run, Queue
import zmq
from zmq.asyncio import Context, Socket

async def zmq_push(q: Queue):
    ctx = Context()
    sock = ctx.socket(zmq.PUSH)
    sock.connect('127.0.0.1', 9999)
    while True:
        payload: Dict = await q.get()
        await sock.send_json(payload)

    ctx.destroy()
</code></pre>
    </div>
    <div class="col" style="padding: 10px">
      <h3>Server</h3>
      <pre><code class="hljs python" contenteditable="true" data-trim="true">from asyncio import run, Queue
import zmq
from zmq.asyncio import Context, Socket

async def zmq_pull(q: Queue):
    ctx = Context()
    sock = ctx.socket(zmq.PULL)
    sock.bind('127.0.0.1', 9999)
    while True:
        payload = await sock.recv_json()
        await q.put()

    ctx.destroy()
</code></pre>
    </div>
  </div>
</section>
<section>
  <h2>Client-server: Design</h2>
  <div class="container">
    <div class="col" style="padding: 10px">
      <h3>Client</h3>
      <ol>
        <li class="fragment" style="font-size: 0.7em">client connects to server</li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Task A: </strong>send player input (keyboard, mouse) e.g. 30 Hz
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Task B: </strong>receive game state (position, health) from server
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Task C: </strong>draw game state on screen
        </li>
      </ol>
    </div>
    <div class="col" style="padding: 10px">
      <h3>Server</h3>
      <ol>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Task A: </strong>accept client connections
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Task B: </strong>
          <ol>
            <li>receive player input</li>
            <li>update game state</li>
          </ol>
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Task C: </strong>send game state to clients, e.g. 15 Hz
        </li>
      </ol>
    </div>
  </div>
  <p class="fragment">Each of the internal tasks runs independently.</p>
</section>
<section>
  <h4>Let's begin with the server</h4>
  <p>(It's easier)</p>
</section>
<section>
  <h3>Server code - main (1/2)</h3>
  <pre style="font-size: 0.5em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">async def main():
    fut = asyncio.Future()  # IGNORE!
    app = App(signal=fut)   # IGNORE!

    gs = GameState(player_states=[PlayerState(speed=150)])

    ctx = Context()  # &quot;<mark>Task A</mark>&quot; (ZeroMQ)

    sock_B: Socket = ctx.socket(zmq.PULL)
    sock_B.bind('tcp://*:25001')
    <mark>task_B</mark> = create_task(update_from_client(gs, sock_B))

    sock_C: Socket = ctx.socket(zmq.PUB)
    sock_C.bind('tcp://*:25000')
    <mark>task_C</mark> = create_task(push_game_state(gs, sock_C))

    try:
        await asyncio.wait([task_B, task_C, fut], return_when=asyncio.FIRST_COMPLETED)
    except CancelledError:
        print('Cancelled')
    finally:
        sock_B.close(1)
        sock_C.close(1)
        ctx.destroy(linger=1)
</code></pre>
</section>
<section>
  <h3>Server code - task detail (2/2)</h3>
  <pre style="font-size: 0.4em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">async def update_from_client(gs: GameState, sock: Socket):
    &quot;&quot;&quot; <mark>TASK B</mark> &quot;&quot;&quot;
    try:
        while True:
            msg = await sock.recv_json()
            event_dict = msg['event']
            print(f'Got event dict: {event_dict}')
            event = PlayerEvent(**event_dict)
            update_game_state(gs, event)
    except asyncio.CancelledError:
        pass

def update_game_state(gs: GameState, event: PlayerEvent):
    for ps in gs.player_states:
        p = Vec2d(ps.x, ps.y)
        dt = time.time() - ps.updated
        p = apply_movement(ps.speed, dt, p, event)
        ps.x, ps.y = p.x, p.y
        ps.updated = time.time()

async def push_game_state(gs: GameState, sock: Socket):
    &quot;&quot;&quot; <mark>TASK C</mark> &quot;&quot;&quot;
    try:
        while True:
            await sock.send_string(gs.to_json())
            await asyncio.sleep(1 / SERVER_UPDATE_TICK_HZ)
    except asyncio.CancelledError:
        pass
</code></pre>
</section>
<section>
  <h2>Client code needs TWO loops!</h2>
  <ul>
    <li>python-arcade: game loop</li>
    <li>asyncio: IO loop</li>
    <li>
      <b>Cannot </b>run both loops in same thread
    </li>
  </ul>
  <p>Least-effort solution: run asyncio loop in a thread</p>
</section>
<section>
  <h3>Client code - main (1/3)</h3>
  <pre style="font-size: 0.5em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">
def thread_worker(window: MyGame):
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    loop.create_task(<mark>iomain</mark>(window, loop))
    loop.run_forever()

def main():
    window = <mark>MyGame</mark>(SCREEN_WIDTH, SCREEN_HEIGHT)
    thread = threading.Thread(
        target=thread_worker, args=(window,), daemon=True)
    thread.start()
    arcade.run()

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
</section>
<section>
  <h3>Client code - iomain thread (2/3)</h3>
  <pre style="font-size: 0.4em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">
async def <mark>iomain</mark>(window: MyGame, loop):
    ctx = Context()

    sub_sock: Socket = ctx.socket(zmq.SUB)
    sub_sock.connect('tcp://localhost:25000')
    sub_sock.subscribe('')  # Required for PUB+SUB

    push_sock: Socket = ctx.socket(zmq.PUSH)
    push_sock.connect('tcp://localhost:25001')

    async def send_player_input():
        &quot;&quot;&quot; Task A &quot;&quot;&quot;
        while True:
            d = asdict(<mark>window.player_input</mark>)
            msg = dict(event=d)
            await push_sock.send_json(msg)
            await asyncio.sleep(1 / UPDATE_TICK)

    async def receive_game_state():
        &quot;&quot;&quot; Task B &quot;&quot;&quot;
        while True:
            gs_string = await sub_sock.recv_string()
            <mark>window.game_state.from_json</mark>(gs_string)
            ps = window.game_state.player_states[0]
            <mark>window.player.position</mark> = Vec2d(ps.x, ps.y)

    try:
        await asyncio.gather(send_player_input(), receive_game_state())
    finally:
        sub_sock.close(1)
        push_sock.close(1)
</code></pre>
</section>
<section>
  <h3>Client code - game object (3/3)</h3>
  <pre style="font-size: 0.4em"><code class="hljs python" data-noescape="true" data-trim="true" style="max-height: unset">
class Rectangle:
    def __init__(self, x, y, color, filled=True):
        self.position = Vec2d(x, y)
        self.color = color
        self.filled = filled

    def draw(self):
      if self.filled:
        arcade.draw_rectangle_filled(self.position.x, self.position.y, 50, 50, self.color)
      else:
        arcade.draw_rectangle_outline(self.position.x, self.position.y, 50, 50, self.color, border_width=4)

class <mark>MyGame</mark>(arcade.Window):
    def __init__(self, width, height):
        super().__init__(width, height, title=&quot;Multiplayer Demo&quot;)
        arcade.set_background_color(arcade.color.GRAY)
        self.game_state = GameState(player_states=[PlayerState()])
        self.player = Rectangle(0, 0, arcade.color.GREEN_YELLOW, filled=False)
        self.player_input = PlayerEvent()

    def update(self, dt):
        <mark>pass</mark>

    def on_draw(self):
        arcade.start_render()
        self.player.draw()

    def on_key_press(self, key, modifiers):
        self.player_input.keys[key] = True

    def on_key_release(self, key, modifiers):
        self.player_input.keys[key] = False

</code></pre>
</section>
<section>
  <h2>Success demo!</h2>
  <button class="runprogram" cmd="demos.server02">server</button>
  <button class="runprogram" cmd="demos.client02b">client</button>
</section>
<section>
  <p>End*</p>
</section>
<section>
  <h5>(Not success - it's laggy)!</h5>
</section>
<section>
  <h2>Sprite interpolation</h2>
  <img src="/img/prevlatestupdate.svg" width="80%">
</section>
<section>
  <h3>Client-side extrapolation</h3>
  <p>Need to understand 
    <u>motion</u>, i.e., speed
  </p>
  <script type="math/tex; mode=display">
v_x = \frac{x_1 - x_0}{t_1 - t_0} \qquad v_y = \frac{y_1 - y_0}{t_1 - t_0}
</script>
  <p class="fragment">This describes the past‚Äîwhat about the future?</p>
  <div class="fragment">
    <script class="fragment" type="math/tex; mode=display">
v_x = \frac{\color{red}{x_2} - x_1}
{\color{red}{t_2} - t_1} \qquad v_y =
\frac{\color{red}{y_2} - y_1}{\color{red}{t_2} - t_1}
</script>
  </div>
</section>
<section>
  <h3>Client-side interpolation</h3>
  <script type="math/text; mode=display">
v_x = \frac{\color{red}{x_2} - x_1}
{\color{red}{t_2} - t_1} \qquad v_y =
\frac{\color{red}{y_2} - y_1}{\color{red}{t_2} - t_1}
</script>
  <p class="fragment">Make the predicted values explicit:</p>
  <div class="fragment">
    <script class="fragment" type="math/tex; mode=display">
\color{red}{x_2} = v_x \times \Delta t + x_1
\qquad
\color{red}{y_2} = v_y \times \Delta t + y_1
</script>
  </div>
</section>
<section>
  <h3>Client-side interpolation</h3>
  <ul>
    <li>Store last 2 server updates</li>
    <li>Calculate predicted future update (extrapolation)</li>
    <li>DRAW interpolated positions between &quot;now&quot; and the predicted future position.</li>
  </ul>
</section>
<section>
  <h2>Success demo attempt #2!</h2>
  <p>Prediction + interpolation (2 Hz server updates)</p>
  <button class="runprogram" cmd="demos.server02c">server</button>
  <button class="runprogram" cmd="demos.client02c">client</button>
  <p>Prediction + interpolation (10 Hz server updates)</p>
  <button class="runprogram" cmd="demos.server02">server</button>
  <button class="runprogram" cmd="demos.client02">client</button>
</section>
<section>
  <p>The end!</p>
</section>
    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>
    // More info about config & dependencies:
    // - https://github.com/hakimel/reveal.js#configuration
    // - https://github.com/hakimel/reveal.js#dependencies
    Reveal.initialize({
        transition: 'none',
        math: {
            mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
            config: 'TeX-AMS_HTML-full'  // See http://docs.mathjax.org/en/latest/config-files.html
        },
        dependencies: [
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/math/math.js', async: true},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {
                src: 'plugin/highlight/highlight.js',
                async: true,
                callback: function () {
                    hljs.initHighlightingOnLoad();
                }
            }
        ]
    });
</script>
<script>
    var btns = document.getElementsByClassName("runprogram");
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener("click", function (event) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/runprog', true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function () {//Call a function when the state changes.
                if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    // Request finished. Do processing here.
                    console.log('Done')
                }
            };
            // xhr.send("foo=bar&lorem=ipsum");
            var btn = event.target;
            var data = {};
            for (var i = btn.attributes.length - 1; i >= 0; i--) {
                data[btn.attributes[i].name] = btn.attributes[i].value
            }
            console.log(data);
            xhr.send(JSON.stringify(data));
        })
    }
    // document.getElementById("b1").addEventListener("click", function(event) {
    //     var xhr = new XMLHttpRequest();
    //     xhr.open("POST", '/runprog', true);
    //     xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    //     xhr.onreadystatechange = function() {//Call a function when the state changes.
    //         if(this.readyState == XMLHttpRequest.DONE && this.status == 200) {
    //             // Request finished. Do processing here.
    //             console.log('Done')
    //         }
    //     };
    //     // xhr.send("foo=bar&lorem=ipsum");
    //     var data = {};
    //     for(var i = this.attributes.length - 1; i >= 0; i--) {
    //         data[this.attributes[i].name] = this.attributes[i].value
    //     }
    //     console.log(data);
    //     xhr.send(JSON.stringify(data));
    // })
</script>
</body>
</html>
