<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>reveal.js</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/github.css">

    <style>
        .reveal {
            font-size: 36px;
        }
        .reveal pre {
            width: unset;
        }

        .reveal mark {
            color: #080e1b;
            background-color: #fff400;
        }

        .container {
            display: flex;
        }

        .col {
            flex: 1;
        }

        .reveal div.container p {
            margin: 0;
        }

        .reveal section img {
            border: none;
        }

        .reveal {
            font-family: "Liberation Sans", SansSerif;
        }

        .reveal code {
            font-family: "Liga Cousine", "Liberation Mono", Monospaced;
        }

        .reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
            font-family: "Liberation Sans", SansSerif;
        }

        .reveal h1 {
            font-size: 2.6em;
        }

        .reveal h2 {
            font-size: 1.8em;
        }
    </style>

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
  <h1>multiplayer 2D gaming</h1>
  <h2>with python-arcade</h2>
  <p style="font-size: 0.8em">@caleb_hattingh ‚óè 
    <a href="github.com/cjrh">github.com/cjrh</a>
  </p>
  <button class="runprogram" cmd="server02">server02</button>
  <button class="runprogram" cmd="client02">client02</button>
</section>
<section>
  <h2>WARNING</h2>
  <h3>Screen flickering later</h3>
</section>
<section>
  <h2>about me</h2>
  <ul>
    <li>
      <p>Network automation at 
        <img height="42" src="/img/pccwglobal.png" style="vertical-align:middle;">
      </p>
    </li>
    <li>Books and videos at O'Reilly Safari:</li>
  </ul>
  <div>
    <img height="250" src="/img/cythoncover.jpg">
    <img height="250" src="/img/20libscover.png">
    <div style="display: inline-block">
      <p style="font-size: 0.6em; margin: 0">April 2018!</p>
      <img height="250" src="/img/aiocover.png">
    </div>
  </div>
</section>
<section>
  <h2>Python-Arcade</h2>
  <p>created by Paul Craven ‚óè
    <a href="http://arcade.academy">http://arcade.academy</a>
  </p>
  <div style="display: flex; margin: auto">
    <img data-src="img/penguin.png" height="48" width="48">
    <pre><code class="hljs bash" contenteditable="contenteditable" data-trim="data-trim">                    (venv) $ pip install arcade
                </code></pre>
  </div>
  <div style="display: flex; margin: auto">
    <img data-src="img/windows_icon.png" height="48" width="48">
    <pre><code class="hljs cmd" contenteditable="contenteditable" data-trim="data-trim">                    (venv) C:\mygame&gt; pip install arcade
                </code></pre>
  </div>
</section>
<section>
  <img src="/img/arcade_doc_screenshot.png">
</section>
<section>
  <h2>Why Python-Arcade?</h2>
  <ul>
    <li>Easy to install</li>
    <li>OpenGL (via Pyglet)</li>
    <li>Modern (Python 3 only, type annotations)</li>
    <li>
      <code>(0, 0)</code> is at the bottom-left
    </li>
    <li>Very clean, simple API</li>
    <li class="fragment">
      <strong>Examples üéÅüéÅüéÅ</strong>
    </li>
  </ul>
</section>
<section>
  <h2>
    <u>lots</u> of examples
  </h2>
  <div class="container" style="font-size: 0.3em;">
    <div class="col">
      <p>array_backed_grid.py</p>
      <p>array_backed_grid_buffered.py</p>
      <p>asteroid_smasher.py</p>
      <p>bouncing_ball.py</p>
      <p>bouncing_balls.py</p>
      <p>bouncing_rectangle.py</p>
      <p>decorator_drawing_example.py</p>
      <p>decorator_drawing_with_loops.py</p>
      <p>decorator_test.py</p>
      <p>drawing_primitives.py</p>
      <p>drawing_text.py</p>
      <p>drawing_with_functions.py</p>
      <p>drawing_with_loops.py</p>
      <p>full_screen_example.py</p>
      <p>gradients.py</p>
      <p>gui_text_button.py</p>
      <p>happy_face.py</p>
      <p>instruction_and_game_over_screens.py</p>
      <p>isometric_example.py</p>
      <p>joystick.py</p>
      <p>lines_buffered.py</p>
      <p>maze_depth_first.py</p>
      <p>maze_recursive.py</p>
      <p>mountains_midpoint_displacement.py</p>
      <p>mountains_random_walk.py</p>
      <p>move_joystick.py</p>
      <p>move_keyboard.py</p>
      <p>move_mouse.py</p>
      <p>nested_loops_bottom_left_triangle.py</p>
      <p>nested_loops_bottom_right_triangle.py</p>
      <p>nested_loops_box.py</p>
    </div>
    <div class="col">
      <p>nested_loops_top_left_triangle.py</p>
      <p>nested_loops_top_right_triangle.py</p>
      <p>pinball.py</p>
      <p>procedural_caves_bsp.py</p>
      <p>procedural_caves_cellular.py</p>
      <p>pymunk_2.py</p>
      <p>pymunk_box_stacks.py</p>
      <p>pymunk_pegboard.py</p>
      <p>radar_sweep.py</p>
      <p>resizable_window.py</p>
      <p>scratch.py</p>
      <p>shape_list_demo_1.py</p>
      <p>shape_list_demo_2.py</p>
      <p>shape_list_demo_3.py</p>
      <p>shape_list_demo_person.py</p>
      <p>shape_list_demo_skylines.py</p>
      <p>shape_list_non_center_rotate.py</p>
      <p>shapes.py</p>
      <p>snow.py</p>
      <p>sound.py</p>
      <p>sound_test.py</p>
      <p>sprite_bullets.py</p>
      <p>sprite_bullets_aimed.py</p>
      <p>sprite_bullets_enemy_aims.py</p>
      <p>sprite_bullets_periodic.py</p>
      <p>sprite_bullets_random.py</p>
      <p>sprite_change_coins.py</p>
      <p>sprite_collect_coins.py</p>
      <p>sprite_collect_coins_background.py</p>
      <p>sprite_collect_coins_diff_levels.py</p>
      <p>sprite_collect_coins_move_bouncing.py</p>
    </div>
    <div class="col">
      <p>sprite_collect_coins_move_circle.py</p>
      <p>sprite_collect_coins_move_down.py</p>
      <p>sprite_collect_coins_move_down_improved.py</p>
      <p>sprite_collect_rotating.py</p>
      <p>sprite_enemies_in_platformer.py</p>
      <p>sprite_explosion.py</p>
      <p>sprite_face_left_or_right.py</p>
      <p>sprite_follow_simple.py</p>
      <p>sprite_follow_simple_2.py</p>
      <p>sprite_move_animation.py</p>
      <p>sprite_move_joystick.py</p>
      <p>sprite_move_keyboard.py</p>
      <p>sprite_move_scrolling.py</p>
      <p>sprite_move_walls.py</p>
      <p>sprite_moving_platforms.py</p>
      <p>sprite_no_coins_on_walls.py</p>
      <p>sprite_ramps.py</p>
      <p>sprite_rooms.py</p>
      <p>sprite_simple_platformer.py</p>
      <p>sprite_tiled_map.py</p>
      <p>starting_template.py</p>
      <p>starting_template_simple.py</p>
      <p>stress_test_collision.py</p>
      <p>stress_test_draw_moving.py</p>
      <p>stress_test_draw_simple.py</p>
      <p>test.py</p>
      <p>test2.py</p>
      <p>test3.py</p>
      <p>timer.py</p>
    </div>
  </div>
</section>
<section>
  <h2>lots of examples</h2>
  <ul>
    <li>
      <pre><code class="hljs bash" contenteditable="true" data-noescape="true" data-trim="true">(venv) $ python -m arcade.examples.<mark>bouncing_ball</mark></code></pre>
    </li>
    <li>
      <pre><code class="hljs bash" contenteditable="true" data-noescape="true" data-trim="true">(venv) $ python -m arcade.examples.<mark>drawing_text</mark></code></pre>
    </li>
    <li>
      <pre><code class="hljs bash" contenteditable="true" data-noescape="true" data-trim="true">(venv) $ python -m arcade.examples.<mark>full_screen_example</mark></code></pre>
    </li>
    <li>
      <pre><code class="hljs bash" contenteditable="true" data-noescape="true" data-trim="true">(venv) $ python -m arcade.examples.<mark>sprite_move_keyboard</mark></code></pre>
    </li>
  </ul>
</section>
<section>
  <h2>The Big Picture</h2>
  <p>picture of server and networked pcs</p>
</section>
<section style="top: 50px">
  <h2>Getting started</h2>
  <pre style="font-size: 0.4em"><code class="hljs python" contenteditable="true" data-trim="true" style="max-height: unset">import arcade
from pymunk.vec2d import Vec2d
from demos.movement import KeysPressed, MOVE_MAP, apply_movement

class MyGame(arcade.Window):
    def __init__(self, width, height):
        super().__init__(width, height, title=&quot;Getting Started&quot;)
        self.player_position = Vec2d(400, 300)
        self.keys_pressed = KeysPressed()

    def update(self, dt):
        self.player_position = apply_movement(
            speed=600, dt=dt, current_position=self.player_position, kp=self.keys_pressed)

    def on_draw(self):
        arcade.start_render()
        arcade.draw_rectangle_filled(
            center_x=self.player_position.x, center_y=self.player_position.y,
            width=50, height=50, color=arcade.color.GREEN_YELLOW, tilt_angle=0)

    def on_key_press(self, key, modifiers):
        self.keys_pressed.keys[key] = True

    def on_key_release(self, key, modifiers):
        self.keys_pressed.keys[key] = False

if __name__ == &quot;__main__&quot;:
    window = MyGame(800, 600)
    arcade.run()
</code></pre>
  <button class="runprogram" cmd="getting_started">getting_started.py</button>
</section>
<section>
  <h2>Components</h2>
  <div class="container">
    <div class="col" style="padding: 10px">
      <h3>Client</h3>
      <ol>
        <li class="fragment" style="font-size: 0.7em">client connects to server</li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Loop A: </strong>send player input (keyboard, mouse) e.g. 30 Hz
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Loop B: </strong>receive game state (position, health) from server
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Loop C: </strong>draw game state on screen
        </li>
      </ol>
    </div>
    <div class="col" style="padding: 10px">
      <h3>Server</h3>
      <ol>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Loop A: </strong>accept client connections
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Loop B: </strong>
          <ol>
            <li>receive player input</li>
            <li>update game state</li>
          </ol>
        </li>
        <li class="fragment" style="font-size: 0.7em">
          <strong>Loop C: </strong>send game state to clients, e.g. 60 Hz
        </li>
      </ol>
    </div>
  </div>
  <p class="fragment">Each of the internal loops runs independently.</p>
</section>
<section>
  <h2>üéÅtip #1: use a vector class</h2>
  <p>Use the one in 
    <strong>pymunk</strong>
  </p>
  <pre><code class="hljs python" contenteditable="true" data-trim="true">&gt;&gt;&gt; from pymunk.vec2d import Vec2d
&gt;&gt;&gt; pixel = Vec2d(3, 4)
&gt;&gt;&gt; pixel.x
3
&gt;&gt;&gt; pixel.y
4
&gt;&gt;&gt;
&gt;&gt;&gt; pixel + 2 * pixel
Vec2d(9, 12)
&gt;&gt;&gt; pixel.length
5.0
&gt;&gt;&gt; pixel.length = 1
&gt;&gt;&gt; pixel
Vec2d(0.6, 0.8)
</code></pre>
</section>
<section>
  <h2>üéÅtip #2: save &amp; load game data</h2>
  <p>Use the one in 
    <strong>pyglet</strong>
  </p>
  <pre><code class="hljs python" contenteditable="true" data-trim="true">import os, pyglet.resource, pathlib

def save_scores(new_scores):
    game_folder = pyglet.resource.get_settings_path(&quot;MyGame&quot;)
    path = pathlib.Path(game_folder, &quot;highscores.txt&quot;)
    path.mkdir(parents=True, exist_ok=True)
    with path.open(&quot;w&quot;) as f:
        f.write(new_scores)
</code></pre>
  <p style="font-size: large">(pyglet gets installed when you install arcade)</p>
</section>
<section>
  <p>Good discussion about lag compensation

https://www.reddit.com/r/Overwatch/comments/3u5kfg/everything_you_need_to_know_about_tick_rate/
https://en.wikipedia.org/wiki/Netcode
https://www.pcgamer.com/netcode-explained/

Some python code here:

https://www.gamedev.net/forums/topic/652377-network-tick-rates/

Book on safari:
https://www.safaribooksonline.com/library/view/fundamentals-of-network/9781584505570/ch01.html    
</p>
</section>
<section data-background-image="/img/shallplaygame.jpg"></section>
<section data-background-image="/img/fortnite3.jpg"></section>
<section data-background-image="/img/starcraft2.jpg"></section>
<section data-background-image="/img/awesomenautsplay.jpg"></section>
<section>
  <h2>Network models</h2>
  <section>
    <ol>
      <li class="fragment">
        <strong>Client-server: </strong>clients only &quot;capture inputs&quot;
        <ul style="font-size: 0.7em;">
          <li>Fortnite</li>
          <li>Quake</li>
          <li>Unreal Tournament</li>
          <li>Overwatch</li>
        </ul>
      </li>
      <li class="fragment">
        <strong>Peer-to-peer (lockstep): </strong>synced sim on each client
        <ul style="font-size: 0.7em;">
          <li>Command &amp; Conquer</li>
          <li>Age of Empires</li>
          <li>StarCraft</li>
          <li>Supreme Commander 2</li>
        </ul>
      </li>
      <li class="fragment">
        <strong>Peer-to-peer: </strong>each client calculates self
        <ul style="font-size: 0.7em;">
          <li>Awesomenauts</li>
        </ul>
      </li>
    </ol>
  </section>
  <section>
    <p style="font-size: 0.6em">References</p>
    <p style="font-size: 0.6em">
      <a href="https://gafferongames.com/post/what_every_programmer_needs_to_know_about_game_networking/">What every programmer needs to know about game networking - Glenn Fiedler</a>
    </p>
    <p style="font-size: 0.6em">
      <a href="http://joostdevblog.blogspot.com/2014/09/core-network-structures-for-games.html">Core network structures for games - Joost van Dongen</a>
    </p>
    <p style="font-size: 0.6em">
      <a href="https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking">Source Multiplayer Networking - Valve</a>
    </p>
  </section>
</section>
<section>
  <h2>Basic networking</h2>
  <p style="font-size: 0.7em;">(assume client-server)</p>
  <ul>
    <li>TCP versus UDP</li>
    <li>Player inputs: client ü†äserver</li>
    <li>Game state: client ü†à server</li>
  </ul>
</section>
<section>
  <h2>TCP vs UDP</h2>
  <ul>
    <li class="fragment">TCP is 
      <strong>too </strong>reliable
      <ul>
        <li>Dropped packets causes latency (bad!)</li>
        <li>Sometimes packet loss is ok</li>
      </ul>
    </li>
    <li class="fragment">UDP chosen for 
      <u>control</u> (not speed)
      <ul>
        <li>Can choose when to allow packet loss...</li>
        <li>BUT: it's much more work</li>
      </ul>
    </li>
  </ul>
</section>
<section>
  <p>But I don't have time to show UDP in this talk!.</p>
  <img src="/img/greenninja.jpg">
  <p>Instead, we'll just show TCP (and ZeroMQ) for simplicity.</p>
</section>
<section>
  <h2>Brief intro to ZeroMQ</h2>
  <p>ZeroMQ has &quot;magic&quot; sockets</p>
  <ul>
    <li class="fragment">Handling player inputs
      <ul>
        <li>PUSH and PULL sockets</li>
        <li>all clients push to a single server</li>
      </ul>
    </li>
    <li class="fragment">Handling game state
      <ul>
        <li>PUB and SUB sockets</li>
        <li>Server pushes to all clients</li>
      </ul>
    </li>
  </ul>
</section>
<section>
  <h2>ZMQ client &amp; server</h2>
  <div class="container">
    <div class="col" style="padding: 10px">
      <h3>Client (player)</h3>
      <pre><code class="hljs python" contenteditable="true" data-trim="true">from asyncio import run, Queue
import zmq
from zmq.asyncio import Context, Socket

async def zmq_push(q: Queue):
    ctx = Context()
    sock = ctx.socket()
    sock.connect('127.0.0.1', 9999)
    while True:
        payload: Dict = await q.get()
        if payload is None: 
            break
        await sock.send_json(payload)

    ctx.destroy()
</code></pre>
    </div>
    <div class="col" style="padding: 10px">
      <h3>Server</h3>
      <pre><code class="hljs python" contenteditable="true" data-trim="true">from asyncio import run, Queue
import zmq
from zmq.asyncio import Context, Socket

async def zmq_pull(q: Queue):
    ctx = Context()
    sock = ctx.socket()
    sock.bind('127.0.0.1', 9999)
    while True:
        payload = await sock.recv_json()
        await q.put()

    ctx.destroy()
</code></pre>
    </div>
  </div>
</section>
<section>
  <h2>Client: send player input to server</h2>
</section>
<section>
  <h2>Server: send game state to client</h2>
</section>
<section>
  <h3>Client-side interpolation</h3>
  <p>Need to understand 
    <u>motion</u>, i.e., speed
  </p>
  <script type="math/text; mode=display">
v_x = \frac{x_1 - x_0}{t_1 - t_0} \qquad v_y = \frac{y_1 - y_0}{t_1 - t_0}
</script>
  <p class="fragment">This describes the past‚Äîwhat about the future?</p>
  <div class="fragment">
    <script class="fragment" type="math/tex; mode=display">
v_x = \frac{\color{red}{x_2} - x_1}
{\color{red}{t_2} - t_1} \qquad v_y =
\frac{\color{red}{y_2} - y_1}{\color{red}{t_2} - t_1}
</script>
  </div>
</section>
<section>
  <h3>Client-side interpolation</h3>
  <script type="math/text; mode=display">
v_x = \frac{\color{red}{x_2} - x_1}
{\color{red}{t_2} - t_1} \qquad v_y =
\frac{\color{red}{y_2} - y_1}{\color{red}{t_2} - t_1}
</script>
  <p class="fragment">Make the predicted values explicit:</p>
  <div class="fragment">
    <script class="fragment" type="math/tex; mode=display">
\color{red}{x_2} = v_x \times \Delta t + x_1
\qquad
\color{red}{y_2} = v_y \times \Delta t + y_1
</script>
  </div>
</section>
    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>
    // More info about config & dependencies:
    // - https://github.com/hakimel/reveal.js#configuration
    // - https://github.com/hakimel/reveal.js#dependencies
    Reveal.initialize({
        transition: 'none',
        math: {
            mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
            config: 'TeX-AMS_HTML-full'  // See http://docs.mathjax.org/en/latest/config-files.html
        },
        dependencies: [
            {src: 'plugin/markdown/marked.js'},
            {src: 'plugin/math/math.js', async: true},
            {src: 'plugin/markdown/markdown.js'},
            {src: 'plugin/notes/notes.js', async: true},
            {
                src: 'plugin/highlight/highlight.js',
                async: true,
                callback: function () {
                    hljs.initHighlightingOnLoad();
                }
            }
        ]
    });
</script>
<script>
    var btns = document.getElementsByClassName("runprogram");
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener("click", function (event) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/runprog', true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function () {//Call a function when the state changes.
                if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    // Request finished. Do processing here.
                    console.log('Done')
                }
            };
            // xhr.send("foo=bar&lorem=ipsum");
            var btn = event.target;
            var data = {};
            for (var i = btn.attributes.length - 1; i >= 0; i--) {
                data[btn.attributes[i].name] = btn.attributes[i].value
            }
            console.log(data);
            xhr.send(JSON.stringify(data));
        })
    }
    // document.getElementById("b1").addEventListener("click", function(event) {
    //     var xhr = new XMLHttpRequest();
    //     xhr.open("POST", '/runprog', true);
    //     xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    //     xhr.onreadystatechange = function() {//Call a function when the state changes.
    //         if(this.readyState == XMLHttpRequest.DONE && this.status == 200) {
    //             // Request finished. Do processing here.
    //             console.log('Done')
    //         }
    //     };
    //     // xhr.send("foo=bar&lorem=ipsum");
    //     var data = {};
    //     for(var i = this.attributes.length - 1; i >= 0; i--) {
    //         data[this.attributes[i].name] = this.attributes[i].value
    //     }
    //     console.log(data);
    //     xhr.send(JSON.stringify(data));
    // })
</script>
</body>
</html>
